{% extends 'base.html' %}

{% block title %}داشبورد ادمین{% endblock %}

{% block content %}
    <h2>داشبورد ادمین</h2>
    <p>مدیریت کاربران و ایجاد کاربر جدید.</p>

    <h3>لیست کاربران سیستم</h3>
    {% if users %}
    <ul>
        {% for user in users %}
            <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px;">
                <div>
                    <strong>ID:</strong> {{ user.id }} |
                    <strong>نام کاربری:</strong> {{ user.username }} |
                    <strong>نقش فعلی:</strong> {{ user.role }}
                </div>

                {# فقط اگر کاربر نمایش داده شده ادمین لاگین شده نباشد #}
                {% if (user.role!= 'admin' or g.user.id == 1) and user.id != g.user.id %}
                    <div style="display: flex; gap: 10px;">

                        {# ---- فرم تغییر نقش ---- #}
                        <form action="{{ url_for('admin_set_user_role', user_id=user.id) }}" method="post" style="display: inline-block; border-right: 1px solid #ccc; padding-right: 10px;">
                            <select name="new_role" style="padding: 5px; margin-bottom: 5px; display: inline-block; width: auto;">
                                <option value="user" {% if user.role == 'user' %}selected{% endif %}>کاربر عادی</option>
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>ادمین</option>
                            </select>
                            <label for="admin_pass_role_{{ user.id }}" style="font-size: 0.8em; display:block;">رمز عبور ادمین:</label>
                            <input type="password" id="admin_pass_role_{{ user.id }}" name="admin_password" required placeholder="رمز عبور شما" style="padding: 5px; margin-bottom: 5px; width: 120px; display: inline-block;">
                            <button type="submit" style="background-color: #ffc107; color: #212529; padding: 5px 8px; font-size: 0.8em;">تغییر نقش</button>
                        </form>

                        {# ---- فرم حذف کاربر ---- #}
                        <div class="delete-user-section" data-user-id="{{ user.id }}">
                            <label for="admin_pass_delete_{{ user.id }}" style="font-size: 0.8em; display:block;">رمز عبور ادمین:</label>
                            <input type="password" id="admin_pass_delete_{{ user.id }}" class="admin-password-for-delete" required placeholder="رمز عبور شما" style="padding: 5px; margin-bottom: 5px; width: 120px; display: inline-block;">
                            <button type="button" class="btn-admin-delete-user"
                                    data-user-id="{{ user.id }}"
                                    data-username="{{ user.username }}"
                                    data-delete-url="{{ url_for('admin_delete_user', user_id=user.id) }}"
                                    style="background-color: #dc3545; padding: 5px 8px; font-size: 0.8em;">
                                حذف کاربر
                            </button>
                            <span class="delete-user-message" style="font-size: 0.8em; margin-left: 5px;"></span>
                        </div>
                    </div>
                {% else %}
                    <small>(مدیریت این کاربر غیرفعال است)</small>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>هیچ کاربری به جز شما در سیستم وجود ندارد.</p>
    {% endif %}

    <hr>

    {# فرم افزودن کاربر جدید (بدون تغییر) #}
    <h3>افزودن کاربر جدید</h3>
    <form action="{{ url_for('admin_create_user') }}" method="post">
         <label for="new_username">نام کاربری:</label>
         <input type="text" id="new_username" name="username" required>
         <label for="new_password">رمز عبور:</label>
         <input type="password" id="new_password" name="password" required>
         <label for="new_role">نقش:</label>
         <select id="new_role" name="role">
             <option value="user" selected>کاربر عادی (User)</option>
             <option value="admin">ادمین (Admin)</option>
         </select>
         <button type="submit" style="background-color: #17a2b8;">ایجاد کاربر</button>
    </form>

    <hr>
    <p><a href="{{ url_for('index') }}">بازگشت به صفحه اصلی</a></p>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- اسکریپت برای حذف کاربر توسط ادمین ---
            document.querySelectorAll('.btn-admin-delete-user').forEach(button => {
                button.addEventListener('click', function () {
                    const userId = this.dataset.userId;
                    const deleteUrl = this.dataset.deleteUrl;
                    const usernameToDelete = this.dataset.username;
        
                    // پیدا کردن فیلد رمز عبور ادمین مربوط به همین کاربر
                    const passwordInput = document.getElementById(`admin_pass_delete_${userId}`);
                    const adminPassword = passwordInput ? passwordInput.value : '';
        
                    const messageSpan = this.closest('.delete-user-section').querySelector('.delete-user-message');
        
                    if (!adminPassword) {
                        if(messageSpan) messageSpan.textContent = 'رمز عبور ادمین الزامی است.';
                        else alert('رمز عبور ادمین الزامی است.');
                        return;
                    }
        
                    if (!confirm(`آیا از حذف کاربر '${usernameToDelete}' (ID: ${userId}) مطمئن هستید؟ این عمل غیرقابل بازگشت است!`)) {
                        return;
                    }
        
                    if(messageSpan) messageSpan.textContent = 'در حال پردازش...';
        
                    fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ admin_password: adminPassword }) // ارسال رمز عبور ادمین
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (body.status === 'success') {
                            const userListItemElement = document.getElementById(`user-list-item-${userId}`);
                            if (userListItemElement) {
                                userListItemElement.remove();
                            }
                            if(messageSpan) messageSpan.textContent = body.message;
                            else alert(body.message); 
                        } else {
                            if(messageSpan) messageSpan.textContent = 'خطا: ' + body.message;
                            else alert('خطا در حذف کاربر: ' + body.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting user by admin:', error);
                        if(messageSpan) messageSpan.textContent = 'خطای ارتباط با سرور.';
                        else alert('خطا در ارتباط با سرور برای حذف کاربر.');
                    });
                });
            });
        });
        </script>
{% endblock %}