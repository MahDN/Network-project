{% extends 'base.html' %}

{% block title %}پروفایل کاربری{% endblock %}

{% block content %}
    <h2>پروفایل کاربری: {{ g.user.username }}</h2>
    <p>در این صفحه می‌توانید رمز عبور خود را تغییر دهید یا حساب کاربری خود را حذف کنید.</p>

    <hr>

    <h3>تغییر رمز عبور</h3>
    {# ... فرم تغییر رمز عبور ... #}
    <form method="post" action="{{ url_for('profile') }}">
        <label for="current_password">رمز عبور فعلی:</label>
        <input type="password" id="current_password" name="current_password" required>
        <label for="new_password">رمز عبور جدید:</label>
        <input type="password" id="new_password" name="new_password" required>
        <label for="confirm_new_password">تکرار رمز عبور جدید:</label>
        <input type="password" id="confirm_new_password" name="confirm_new_password" required>
        <button type="submit" style="background-color: #ffc107; color: #212529;">تغییر رمز عبور</button>
    </form>

    <hr style="border-color: #dc3545; margin-top: 30px; margin-bottom: 30px;">

    {# ---- بخش حذف حساب کاربری ---- #}
    <h3 style="color: #dc3545;">حذف حساب کاربری</h3>
    <p style="color: #dc3545; font-weight: bold;">هشدار: حذف حساب کاربری عملی غیرقابل بازگشت است و تمام اطلاعات شما (از جمله پست‌ها) برای همیشه پاک خواهد شد.</p>
    {# جلوگیری از حذف ادمین اصلی (ID=1) از طریق این فرم #}
    {% if g.user.id == 1 %}
        <p style="color: #6c757d;">ادمین اصلی (ID=1) نمی‌تواند حساب خود را از این طریق حذف کند.</p>
    {% else %}
    <form id="deleteProfileForm" action="{{ url_for('delete_profile') }}" method="POST"> <label for="delete_confirm_password">برای تایید، رمز عبور خود را وارد کنید:</label>
        <input type="password" id="delete_confirm_password" name="password" required>
        <button type="button" id="submitDeleteProfile" style="background-color: #dc3545;">حذف دائمی حساب کاربری من</button>
    </form>
    <div id="deleteProfileMessage" style="margin-top: 10px;"></div> {% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
const deleteButton = document.getElementById('submitDeleteProfile');
const deleteForm = document.getElementById('deleteProfileForm'); // (** برای حملات CSRF پیشنهاد چت **)
const passwordInput = document.getElementById('delete_confirm_password');
const messageDiv = document.getElementById('deleteProfileMessage');

if (deleteButton) {
    deleteButton.addEventListener('click', function (event) {
        event.preventDefault(); // جلوگیری از ارسال پیش‌فرض فرم

        if (!confirm('آیا واقعا مطمئن هستید که می‌خواهید حساب کاربری خود را برای همیشه حذف کنید؟')) {
            return; // اگر کاربر "Cancel" را زد، کاری انجام نده
        }

        const password = passwordInput.value;
        if (!password) {
            messageDiv.textContent = 'لطفا رمز عبور خود را وارد کنید.';
            messageDiv.className = 'flash danger'; // استفاده از کلاس‌های فلش برای نمایش  
            return;
        }

        messageDiv.textContent = 'در حال پردازش...';
        messageDiv.className = 'flash info';

        fetch("{{ url_for('delete_profile') }}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: password })
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data }))) // دریافت وضعیت و بدنه
        .then(({ status, body }) => {
            messageDiv.textContent = body.message || 'پاسخی از سرور دریافت نشد.';
            if (body.status === 'success') {
                messageDiv.className = 'flash success';
                //  ریدایرکت به صفحه ای که سرور گفته
                if (body.redirect_url) {
                    window.location.href = body.redirect_url;
                } else {
                     // اگر URL ریدایرکت نبود، به صفحه اصلی یا لاگین برویم
                    window.location.href = "{{ url_for('login', _external=True) }}";
                }
            } else {
                messageDiv.className = 'flash danger';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageDiv.textContent = 'خطا در برقراری ارتباط با سرور: ' + error;
            messageDiv.className = 'flash danger';
        });
    });
}
});
</script>
{% endblock %}